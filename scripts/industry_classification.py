#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
行业分类映射模块
将证监会行业分类映射到大类，并分配 YoY/QoQ 权重

证监会行业分类标准（GB/T 4754-2017）：
- A: 农、林、牧、渔业
- B: 采矿业
- C: 制造业
- D: 电力、热力、燃气及水生产和供应业
- E: 建筑业
- F: 批发和零售业
- G: 交通运输、仓储和邮政业
- H: 住宿和餐饮业
- I: 信息传输、软件和信息技术服务业
- J: 金融业
- K: 房地产业
- L: 租赁和商务服务业
- M: 科学研究和技术服务业
- N: 水利、环境和公共设施管理业
- O: 居民服务、修理和其他服务业
- P: 教育
- Q: 卫生和社会工作
- R: 文化、体育和娱乐业
- S: 综合
"""

import re
from typing import Dict, Tuple


# ===== 行业代码到大类映射 =====
# 注意：按证监行业大类(1-2位字母+2位数字)映射
INDUSTRY_MAPPING: Dict[str, str] = {
    # ===== A 农、林、牧、渔业 =====
    "A01": "农业", "A02": "林业", "A03": "畜牧业", "A04": "渔业", "A05": "农服",

    # ===== B 采矿业 =====
    "B06": "采矿", "B07": "采矿", "B08": "采矿", "B09": "采矿", "B11": "采矿",

    # ===== C 制造业 - 消费品 =====
    "C01": "消费",  # 农副食品
    "C02": "消费",  # 食品制造
    "C03": "消费",  # 酒饮制造
    "C04": "消费",  # 烟草
    "C05": "消费",  # 纺织
    "C06": "消费",  # 纺织服装
    "C07": "消费",  # 皮革
    "C08": "消费",  # 木材
    "C09": "消费",  # 家具
    "C10": "消费",  # 造纸
    "C11": "消费",  # 印刷
    "C12": "消费",  # 文教体育
    "C13": "制造",  # 电气机械（混合）
    "C14": "制造",  # 电子设备（混合）
    "C15": "消费",  # 其他制造
    "C16": "消费",  # 废弃资源利用
    "C17": "消费",  # 设备修理
    "C18": "消费",  # 酒饮（重复确认）

    # ===== C 制造业 - 周期制造 =====
    "C26": "制造",  # 通用设备
    "C27": "制造",  # 专用设备
    "C28": "制造",  # 汽车制造
    "C29": "制造",  # 铁路船舶
    "C30": "制造",  # 电气制造
    "C31": "制造",  # 黑色金属 ← 之前错了
    "C32": "制造",  # 有色金属
    "C33": "制造",  # 金属制品
    "C34": "制造",  # 仪器仪表

    # ===== C 制造业 - 医药制造 =====
    "C40": "医药",  # 医药制造
    "C41": "医药",  # 医疗仪器
    "C42": "医药",  # 医药批发

    # ===== D 电力、热力、燃气及水 =====
    "D44": "公用",  # 电力、热力生产和供应业
    "D45": "公用",  # 燃气生产和供应业
    "D46": "公用",  # 水的生产和供应业

    # ===== E 建筑业 =====
    "E47": "建筑",  # 房屋建筑
    "E48": "建筑",  # 土木工程
    "E49": "建筑",  # 建筑安装
    "E50": "建筑",  # 建筑装饰

    # ===== F 批发和零售业 =====
    "F51": "消费",  # 批发
    "F52": "消费",  # 零售

    # ===== G 交通运输 =====
    "G53": "交运",  # 铁路运输
    "G54": "交运",  # 道路运输
    "G55": "交运",  # 水上运输
    "G56": "交运",  # 航空运输
    "G57": "交运",  # 管道运输
    "G58": "交运",  # 仓储
    "G59": "交运",  # 邮政

    # ===== H 住宿和餐饮 =====
    "H61": "消费",  # 住宿
    "H62": "消费",  # 餐饮

    # ===== I 信息技术 =====
    "I63": "科技",  # 电信
    "I64": "科技",  # 互联网
    "I65": "科技",  # 软件

    # ===== J 金融业 =====
    "J66": "金融",  # 货币金融
    "J67": "金融",  # 资本市场
    "J68": "金融",  # 保险
    "J69": "金融",  # 其他金融

    # ===== K 房地产业 =====
    "K70": "地产",  # 房地产

    # ===== L 租赁和商务 =====
    "L71": "服务",  # 租赁
    "L72": "服务",  # 商务

    # ===== M 科学研究 =====
    "M73": "科技",  # 科研

    # ===== N 水利环境 =====
    "N76": "公用",  # 水利
    "N77": "公用",  # 生态
    "N78": "公用",  # 公共设施

    # ===== O 居民服务 =====
    "O81": "服务",  # 居民服务
    "O82": "制造",  # 设备修理

    # ===== P 教育 =====
    "P83": "服务",  # 教育

    # ===== Q 卫生 =====
    "Q84": "医药",  # 卫生

    # ===== R 文化体育 =====
    "R85": "消费",  # 文化体育

    # ===== S 综合 =====
    "S90": "服务",  # 综合
}


# ===== 行业大类权重配置 =====
INDUSTRY_WEIGHTS: Dict[str, Dict[str, float]] = {
    # ===== 强季节性（YoY权重高） =====
    "消费": {"yoy": 0.70, "qoq": 0.30},
    "地产": {"yoy": 0.70, "qoq": 0.30},
    "周期": {"yoy": 0.70, "qoq": 0.30},  # 如黑色金属

    # ===== 中等季节性 =====
    "医药": {"yoy": 0.60, "qoq": 0.40},
    "金融": {"yoy": 0.60, "qoq": 0.40},
    "公用": {"yoy": 0.60, "qoq": 0.40},
    "交运": {"yoy": 0.60, "qoq": 0.40},
    "建筑": {"yoy": 0.60, "qoq": 0.40},
    "农业": {"yoy": 0.60, "qoq": 0.40},

    # ===== 弱季节性（QoQ权重高） =====
    "科技": {"yoy": 0.50, "qoq": 0.50},
    "制造": {"yoy": 0.55, "qoq": 0.45},

    # ===== 服务类 =====
    "服务": {"yoy": 0.60, "qoq": 0.40},
    "采矿": {"yoy": 0.60, "qoq": 0.40},
    "农服": {"yoy": 0.60, "qoq": 0.40},

    # ===== 默认配置 =====
    "其他": {"yoy": 0.60, "qoq": 0.40},
}


def get_industry_category(industry_name: str) -> str:
    """
    根据BaoStock行业名称提取大类分类

    Args:
        industry_name: BaoStock返回的行业名称，如 "C15酒、饮料和精制茶制造业"

    Returns:
        大类名称：消费/医药/科技/金融/制造/公用/交运/地产/其他
    """
    if not industry_name:
        return "其他"

    # 提取代码前缀（如 "C15酒..." -> "C15"）
    match = re.match(r'^([A-Z]\d{2})', industry_name)

    if match:
        code = match.group(1)  # 如 "C15"
    else:
        # 兜底：取前两个字符
        code = industry_name[:2] if len(industry_name) >= 2 else industry_name

    return INDUSTRY_MAPPING.get(code, "其他")


def get_weights_from_name(industry_name: str) -> Tuple[float, float]:
    """
    从BaoStock行业名称获取 YoY/QoQ 权重

    Args:
        industry_name: BaoStock返回的行业名称

    Returns:
        (yoy_weight, qoq_weight)
    """
    category = get_industry_category(industry_name)
    weights = INDUSTRY_WEIGHTS.get(category, INDUSTRY_WEIGHTS["其他"])
    return weights["yoy"], weights["qoq"]


# ===== 测试 =====
if __name__ == "__main__":
    print("=" * 70)
    print("行业分类映射测试")
    print("=" * 70)

    test_cases = [
        ("C15酒、饮料和精制茶制造业", "消费"),
        ("J66货币金融服务", "金融"),
        ("I63电信、广播电视和卫星传输服务", "科技"),
        ("C40医药制造业", "医药"),
        ("C31黑色金属冶炼和压延加工业", "制造"),
        ("K70房地产业", "地产"),
        ("G56航空运输业", "交运"),
        ("D44电力、热力生产和供应业", "公用"),
        ("F52零售业", "消费"),
        ("B06煤炭开采和洗选业", "采矿"),
    ]

    all_passed = True
    for name, expected in test_cases:
        category = get_industry_category(name)
        yoy, qoq = get_weights_from_name(name)
        status = "✅" if category == expected else "❌"
        if category != expected:
            all_passed = False
        print(f"{status} {name[:30]:30s} → {category:6s} (预期:{expected:6s}) | YoY:{yoy:.0%}, QoQ:{qoq:.0%}")

    print("=" * 70)
    if all_passed:
        print("✅ 所有测试通过!")
    else:
        print("❌ 有测试失败")
    print("=" * 70)
