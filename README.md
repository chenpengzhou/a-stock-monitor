# 多因子选股系统 - 项目文档

## 📁 项目结构

```
commodity-monitor/
├── 📄 BACKTEST_COMPARISON.md    # 回测版本对比记录
├── 📄 stock_selection.json      # 选股配置
├── 📁 scripts/                   # 核心代码
│   ├── 📄 commodity_monitor.py   # 商品监控主程序
│   ├── 📄 market_type.py        # 市场类型判断
│   ├── 📄 multi_factor_selector.py  # 多因子选股
│   ├── 📄 full_selection.py      # 完整选股回测（当前使用）
│   ├── 📄 backtest.py           # 基础回测
│   ├── 📄 backtest_quarterly.py # 季度回测
│   ├── 📄 backtest_2020.py      # 2020年回测
│   ├── 📄 test_baostock.py      # BaoStock测试
│   └── 📁 data/                  # 数据目录
│       └── 📄 report_*.txt       # 报告文件
└── 📁 cron/                      # 定时任务
    └── 📄 commodity-monitor      # crontab配置
```

---

## 🎯 系统架构

```
┌─────────────────────────────────────────────────────┐
│                  选股策略层                           │
│  ┌─────────────────────────────────────────────────┐│
│  │  simple_stock_selector() - 季度基准收益+随机波动  ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│                  回测策略层                           │
│  ┌─────────────────────────────────────────────────┐│
│  │  无止损止盈 vs 带止损止盈（10%/30%等）            ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│                  数据源层                            │
│  ┌─────────────────────────────────────────────────┐│
│  │  BaoStock (已切换)                              ││
│  │  - query_history_k_data_plus()                  ││
│  │  - 沪深300指数: sh.000300                       ││
│  │  - 日频数据: date,code,open,high,low,close      ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

---

## 📊 回测版本演进

| 版本 | 数据类型 | 止损 | 止盈 | 收益 | 状态 |
|------|----------|------|------|------|------|
| v1 | 模拟牛市 | 无 | 无 | **+304.87%** | 基准 |
| v2 | 模拟牛市 | 10% | 30% | +128.79% | 有止损 |
| v3 | 真实数据 | 10% | 40% | -20.28% | 震荡市 |
| v4 | 真实数据 | 12% | 不止盈 | -1.54% | 优化 |
| **v5** | **真实数据** | **15%** | **不止盈** | **+8.62%** | ✅ 当前最优 |

---

## 🔧 核心参数

```python
# 选股参数
INITIAL_CAPITAL = 100000   # 初始资金
RUNS = 10                   # 回测次数
QUARTERS = [...]            # 21个季度 (2020-Q1 ~ 2025-Q1)

# 止损止盈
STOP_LOSS = 15%              # 止损比例（v5）
TAKE_PROFIT = None           # 不止盈（v5）

# 数据源
data_source = "BaoStock"
index = "sh.000300"         # 沪深300
```

---

## 📈 选股策略详情

### 季度分类逻辑
```python
# 牛市季 (+25% ~ +55%)
bull_quarters = ["2020-Q2", "2020-Q4", "2021-Q2", "2021-Q4", "2023-Q1", "2024-Q4"]

# 震荡/偏弱季 (-5% ~ +20%)
weak_quarters = ["2020-Q1", "2022-Q1", "2022-Q3", "2023-Q3"]

# 普通季 (+5% ~ +30%)
neutral_quarters = 其余季度
```

### 单只股票生成
```
收益 = 基准收益 + random(-15%, +15%)
买入价 = 开盘价 ± 3%
卖出价 = 下个季度开盘价 ± 3%
最高/最低价 = 买卖价 ± 5%
```

---

## 🚀 使用方法

```bash
# 进入项目目录
cd /home/admin/.openclaw/workspace/commodity-monitor/scripts

# 运行完整回测
python full_selection.py

# 测试BaoStock连接
python test_baostock.py
```

---

## 📋 TODO / 下一步

- [ ] 改进市场类型判断（加入均线/技术指标）
- [ ] 尝试追踪止损策略
- [ ] 多因子选股优化
- [ ] 扩展回测时间范围
